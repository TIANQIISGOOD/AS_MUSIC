## 应用开发实例-音乐播放器

### 1.1 业务流程分析说明

​	点击主页面的”Love”歌单列表中的某一行歌曲,进入该歌曲的详情界面,歌曲 详情页包含以下功能:音乐的播放暂停,播放下一首上一首歌,当前歌曲播放完毕自 动播放下一首,歌曲播放进度条. 

​	其中歌曲的播放,以歌单为单位,点击左上角的”爱心”按钮,打开对应的歌单, 点击歌单中的某一行歌曲,跳转到对应歌曲的详情页.

### 1.2 功能核心技术

#### 1.2.1 OkHttp, Jsoup:

​	网络音乐资源 url 获取

#### 1.2.2 SQLite 数据库,SQLiteOpenHelper,DAO:

​	本地音乐资源管理

#### 1.2.3 Serializable 接口:

​	由 Music 类和 MusicList 类实现，用于在 Intent 中传递 Music 对象以及 其包含的 MusicList 对象

#### 1.2.4 RecyclerView, Adapter:

​	展示音乐列表

#### 1.2.5 Handler,Runnable:

​	在主线程中定时更新 UI

#### 1.2.6 SimpleExoPlayer:

​	通过网络音乐资源的 URL 播放音乐

### 1.3 功能模块说明

#### 1.3.1 后端数据管理

​	数据获取:通过封装的 CrawlMusic 类使用 OkHttp 爬取 Json 解析网络上的 音 乐 资 源 url 将 爬 取 到 的 数 据 存 储 到 SQLite 数 据 库 获 取 . 该 类 在 MainActivity 的 OnCreate 方法中调用,以完成全局的数据初始化



​	数据存储结构设计: musicDbHelper,数据库中包含两个表:MUSICLIST 和 MUSIC_(ID)表,MUSICLIST 表存储的是所有歌单信息,包含一个自增主键_id 列, 用于与其对应的 MUSIC_(ID)关联”ID”就是主键值”_id”;具有唯一性的用于 存储歌单名的 listName 列, 存储歌单的图片位置的 listPicture 列.MUSIC_(ID) 表存储的是每个歌单中存储的具体歌曲信息,包括一个自增主键_id 列,用于后 续的上一首下一首播放逻辑实现, 用于存储音乐名称的 name 列, 用于存储音 乐作者的 author 列, 用于存储音乐 URL 的 URL 列,其中 name 和 author 列的 组合是唯一的。用于保证同一首歌曲不会重复插入.MUSICLIST 中的每一行记录 与一个 MUSIC_(ID)表是一一对应的”ID”就是一行记录所对应主键值”_id” 在这个数据库中有一个特殊的歌单:名为”Love”歌单,其对应的歌表为 MUSIC_1 歌表,该歌单在程序初始化时生成,不可删除



​	数据管理 DAO:用于数据访问的 musicDAO 类，查询歌单信息: 通过歌单名称 查询歌单的详细信息:该操作,在展示音乐列表时,传递参数时使用到.插入歌曲:  根据传入的歌单表编号以及歌曲数据插入数据，如果存在相同的歌曲记录则更 新数据。该操作在将爬取到的歌曲信息存入到数据库中使用到.检查音乐是否存 在:用于辅助插入歌曲.更新音乐数据: 处理存在冲突时的情况,当插入歌曲的 歌曲名和作者相同时,更新其对应的 URL, 用于辅助插入歌曲.查询所有歌曲信 息: 查询某个歌单对应的所有歌曲信息，返回一个包含歌曲详细信息的列表,用 于音乐列表的展示



​	音乐播放应用中的数据模型:Music 类和 MusicList 类.Music 类表示单个 音乐的属性包括歌曲名,作者,URL 以及其对应的歌单，而 MusicList 类表示一 个歌单，包含了多个 Music 对象以及利用 musicDAO 进行各项数据库操作.通 过将这两个类关联起来,以”一首歌曲”为基本的数据单元,实现对歌曲和歌单 的抽象管理以及在业务逻辑中的参数传递.在业务的具体实现中,有一个功能就 是:点击列表中的某一行,跳转到歌曲的详情页,其中 intent 传递的就是一个 Music 实例,由于使用 Intent 传递对象时，这个对象必须是可序列化的,所以这 两个类都实现了一个 Serializable 接口.



#### 1.3.2 前端业务逻辑

​	音乐列表显示: 歌曲列表的展示主要由 Myadapter_musicList 配适器实 现， Myadapter_musicList 将音乐列表数据绑定到每个列表项视图，同时提供 了点击事件的处理逻辑，使得点击某个音乐列表项时能够跳转到音乐详情页面, 并且传递一个 Music 实例。通过将配适器设置给对应的 recyclerView,在垂直 方向上展示一个歌曲列表，该列表展示的是名为"Love"的歌单.



​	音乐播放与暂停:播放音乐,首先释放之前的播放器实例，确保每次播放都 使用一个新的 SimpleExoPlayer 实例，防止多个音乐同时播放。然后创建一个 新的实例，用于播放音乐从音乐列表中获取当前索引对应的音乐对象,并从中获 取当前音乐的播放链接 url,创建 MediaItem 对象，表示要播放的音乐资源。 然后设置播放器要播放的音乐资源。最后调用 player.prepare() 方法,使播放 器进入准备状态。为了实现播放暂停的功能, 设置一个布尔对象 表示当前播放 状态的标志，每次通过取反操作来切换播放状态。通过点击按钮切换音乐的播 放和暂停状态，同时更新相应的 UI 显示.在从歌曲列表跳转到该页面时,通过 传入的 intent 对象获得当前的播放 Music 实例,然后调用相关方法得到当前歌 曲的索引,以及歌曲组,由于获得的是数据库索引,其是从 1 开始,而歌曲又保存 在一个 Array 组中,其索引是从 0 开始的,所以在获取后要-1



​	歌曲切换上一首,下一首: 通过修改 currentSongIndex 来实现歌曲的切 换，然后调用 playCurrentSong() 播放当前索引的歌曲。点击对应的按钮,调 用相应的方法实现歌曲的切换.



​	UI 更新:包括进度条在播放时的动态显示,切换歌曲或当前歌曲播放完成后, 歌曲名,作者,进度条的更新,监听播放状态的变化,当 UI 需要变化时,通过 handler 将更新任务提交到主线程中进行。播放器已准备好可以播放音乐时调用 定时更新进度条的方法,创建一个定时任务，以一定的时间间隔（500 毫秒）更 新一次播放进度条,然后将定时任务提交到主线程，开始执行定时更新进度条的 操作。否则停止更新进度条,从而实现在播放时动态更新进度条的效果。当前歌 曲播放结束时,为了实现轮播,调用播放下一首歌的方法.为了保证播放状态显 示的正确性,一直监听更新播放状态按钮.同样的,该按钮的更新也是提交到主线程中完成的.



​	进度条功能实现: 通过对 SeekBar 的监听，让用户可以通过拖动 SeekBar 来调整音乐的播放位置，并且在拖动时实时更新起始时间的显示。



### 1.4 测试结果

<img width="469" alt="image" src="https://github.com/TIANQIISGOOD/AS_MUSIC/assets/96114236/30ae4bb2-7b26-4407-822b-04093e19f5d9">

<img width="456" alt="image" src="https://github.com/TIANQIISGOOD/AS_MUSIC/assets/96114236/dd1c7d64-7acc-4fdd-9e18-5dd26da5be85">

<img width="475" alt="image" src="https://github.com/TIANQIISGOOD/AS_MUSIC/assets/96114236/5c6dc02a-e517-4a67-ac2a-573394244d26">


